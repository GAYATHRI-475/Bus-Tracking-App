<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Bus Tracking Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; }
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    // Initialize map
    var map = L.map('map');

    // Add base tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Default region
    var defaultPoints = [
        [11.5250, 77.2650],
        [11.3410, 77.7170],
        [11.1085, 77.3411],
        [11.0168, 76.9558]
    ];
    map.fitBounds(L.latLngBounds(defaultPoints).pad(0.15));

    // Global markers and route
    var busMarker = null;
    var studentMarker = null;
    var routeLine = null;

    // Track if user moved map manually
    var userInteracted = false;
    map.on('dragstart zoomstart', function() {
        userInteracted = true;
    });

    // --- Utility functions ---

    // Smooth marker movement
    function smoothMoveMarker(marker, newLat, newLng, duration = 1000) {
        var start = marker.getLatLng();
        var end = L.latLng(newLat, newLng);
        var startTime = performance.now();

        function animate(time) {
            var progress = Math.min((time - startTime) / duration, 1);
            var lat = start.lat + (end.lat - start.lat) * progress;
            var lng = start.lng + (end.lng - start.lng) * progress;
            marker.setLatLng([lat, lng]);
            if (progress < 1) requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);
    }

    // Clear previous bus marker and route
    function clearBusMarkerRoute() {
        if (busMarker) {
            map.removeLayer(busMarker);
            busMarker = null;
        }
        if (routeLine) {
            map.removeLayer(routeLine);
            routeLine = null;
        }
    }

    // Move or place bus marker
    function moveBus(lat, lng) {
        if (busMarker) {
            smoothMoveMarker(busMarker, lat, lng);
        } else {
            busMarker = L.marker([lat, lng], { title: "Bus ðŸšŒ" }).addTo(map);
        }
    }

    // Move or place student marker
    function moveStudent(lat, lng) {
        if (studentMarker) {
            smoothMoveMarker(studentMarker, lat, lng);
        } else {
            studentMarker = L.marker([lat, lng], { title: "You ðŸŽ“" }).addTo(map);
        }
    }

    // Draw or update route from student â†’ bus
    function drawRoute(lat1, lng1, lat2, lng2) {
        const url = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?overview=full&geometries=geojson`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    if (routeLine) {
                        routeLine.setLatLngs(routeCoords);
                    } else {
                        routeLine = L.polyline(routeCoords, { color: 'blue', weight: 5, opacity: 0.8 }).addTo(map);
                    }
                    if (!userInteracted) {
                        map.fitBounds(L.latLngBounds(routeCoords).pad(0.2));
                    }
                } else {
                    console.error("No route found");
                }
            })
            .catch(err => console.error("Routing error:", err));
    }

    // Fit map to all markers
    function updateMapView() {
        const bounds = [];
        if (busMarker) bounds.push(busMarker.getLatLng());
        if (studentMarker) bounds.push(studentMarker.getLatLng());
        if (bounds.length > 0) {
            const group = L.featureGroup(bounds);
            map.fitBounds(group.getBounds().pad(0.3));
        }
    }

    // --- Called from Android app after searching a bus ---
    function onBusSearch(studentLat, studentLng, busLat, busLng) {
        moveStudent(studentLat, studentLng);

        // Clear previous bus marker & route
        clearBusMarkerRoute();

        moveBus(busLat, busLng);
        drawRoute(studentLat, studentLng, busLat, busLng);
        updateMapView();
    }

</script>
</body>
</html>
